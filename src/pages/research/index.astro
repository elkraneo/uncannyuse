---
import { getCollection } from "astro:content";
import Base from "../../layouts/Base.astro";

const claims = (await getCollection("rcp-claims")).sort(
	(a, b) => b.data.date.getTime() - a.data.date.getTime(),
);

const groups = new Map<string, typeof claims>();
for (const claim of claims) {
	const existing = groups.get(claim.data.componentId) ?? [];
	existing.push(claim);
	groups.set(claim.data.componentId, existing);
}

const groupedClaims = [...groups.entries()].sort((a, b) =>
	a[0].localeCompare(b[0]),
);
const componentOptions = groupedClaims.map(([componentId]) => componentId);
const proposeNoteUrl =
	"https://github.com/elkraneo/uncannyuse/issues/new?template=developer_note.yml";

function formatDate(date: Date): string {
	return date.toISOString().slice(0, 10);
}
---

<Base
	title="Reality Composer Pro Development Notes"
	description="Reverse-engineering note index for Reality Composer Pro behavior."
>
	<article class="research-page">
		<header class="research-header">
			<h1>Reality Composer Pro Development Notes</h1>
			<p>
				Evidence-backed notes grouped by component. Open any note for full
				metadata, repro steps, and evidence.
			</p>
			<div class="research-actions">
				<a href={proposeNoteUrl} target="_blank" rel="noopener noreferrer">
					propose note ↗
				</a>
			</div>
			<div class="research-filters">
				<input
					id="notes-search"
					type="search"
					placeholder="search notes…"
					aria-label="Search notes"
				/>
				<select id="component-filter" aria-label="Filter by component">
					<option value="all">all components</option>
					{
						componentOptions.map((componentId) => (
							<option value={componentId}>{componentId}</option>
						))
					}
				</select>
			</div>
		</header>

		{
			groupedClaims.map(([componentId, entries]) => (
				<section class="claim-group" data-claim-group data-component={componentId}>
					<h2>
						<a href={`/features/${componentId}`}>{componentId}</a>
						<span>
							{entries.length} note{entries.length > 1 ? "s" : ""}
						</span>
					</h2>
					<ul class="claim-list">
						{entries.map((claim) => (
							<li
								class="claim-item"
								data-claim-item
								data-component={componentId}
								data-search={`${claim.data.claim} ${claim.data.summary}`.toLowerCase()}
							>
								<a href={`/research/${claim.slug}/`} class="claim-title">
									{claim.data.claim}
								</a>
								<p>{claim.data.summary}</p>
								<div class="claim-meta">
									<span>{claim.data.status}</span>
									<span>{claim.data.confidence}</span>
									<span>{claim.data.scope}</span>
									<span>{formatDate(claim.data.date)}</span>
								</div>
							</li>
						))}
					</ul>
				</section>
			))
		}
	</article>
</Base>

<script>
	const searchInput = document.getElementById("notes-search") as HTMLInputElement | null;
	const componentFilter = document.getElementById("component-filter") as HTMLSelectElement | null;
	const claimItems = document.querySelectorAll<HTMLElement>("[data-claim-item]");
	const claimGroups = document.querySelectorAll<HTMLElement>("[data-claim-group]");

	function applyFilters() {
		const query = (searchInput?.value ?? "").trim().toLowerCase();
		const component = componentFilter?.value ?? "all";

		claimItems.forEach((item) => {
			const itemComponent = item.dataset.component ?? "";
			const haystack = item.dataset.search ?? "";
			const matchesComponent = component === "all" || itemComponent === component;
			const matchesQuery = query.length === 0 || haystack.includes(query);
			item.hidden = !(matchesComponent && matchesQuery);
		});

		claimGroups.forEach((group) => {
			const visibleItems = group.querySelectorAll<HTMLElement>("[data-claim-item]:not([hidden])");
			group.hidden = visibleItems.length === 0;
		});
	}

	searchInput?.addEventListener("input", applyFilters);
	componentFilter?.addEventListener("change", applyFilters);
</script>

<style>
	.research-page {
		max-width: 900px;
		margin: 0 auto;
		padding: 2rem 1.5rem 5rem;
	}

	.research-header h1 {
		font-size: clamp(1.6rem, 3vw, 2.2rem);
	}

	.research-header p {
		margin-top: 0.6rem;
		color: var(--muted);
		max-width: 65ch;
	}

	.research-actions {
		margin-top: 0.75rem;
	}

	.research-actions a {
		font-size: 0.8125rem;
		color: var(--muted);
		text-decoration: none;
		border: 1px solid var(--border);
		border-radius: 5px;
		padding: 0.22rem 0.5rem;
	}

	.research-actions a:hover {
		color: var(--text);
		background: var(--surface-up);
	}

	.research-filters {
		margin-top: 0.8rem;
		display: flex;
		gap: 0.6rem;
		flex-wrap: wrap;
	}

	.research-filters input,
	.research-filters select {
		border: 1px solid var(--border);
		background: var(--surface-up);
		color: var(--text);
		border-radius: 6px;
		padding: 0.35rem 0.55rem;
		font: inherit;
		font-size: 0.85rem;
	}

	.claim-group {
		margin-top: 1.5rem;
		padding-top: 1rem;
		border-top: 1px solid var(--border);
	}

	.claim-group h2 {
		display: flex;
		flex-wrap: wrap;
		gap: 0.6rem;
		align-items: center;
		font-size: 1rem;
	}

	.claim-group h2 a {
		color: var(--text);
		text-decoration: none;
	}

	.claim-group h2 a:hover {
		text-decoration: underline;
	}

	.claim-group h2 span {
		font-size: 0.8rem;
		color: var(--muted);
		border: 1px solid var(--border);
		border-radius: 999px;
		padding: 0.1rem 0.45rem;
	}

	.claim-list {
		list-style: none;
		display: flex;
		flex-direction: column;
		gap: 0.7rem;
		margin-top: 0.8rem;
	}

	.claim-item {
		border: 1px solid var(--border);
		border-radius: 8px;
		padding: 0.7rem 0.8rem;
		background: var(--surface);
	}

	.claim-title {
		color: var(--text);
		text-decoration: none;
		font-weight: 500;
	}

	.claim-title:hover {
		color: var(--ios);
		text-decoration: underline;
	}

	.claim-item p {
		margin-top: 0.35rem;
		color: var(--muted);
		font-size: 0.9rem;
	}

	.claim-meta {
		display: flex;
		flex-wrap: wrap;
		gap: 0.35rem;
		margin-top: 0.55rem;
	}

	.claim-meta span {
		font-size: 0.75rem;
		color: var(--muted);
		border: 1px solid var(--border);
		border-radius: 999px;
		padding: 0.1rem 0.45rem;
	}
</style>
