---
import type { Feature } from "../types";

export interface Props {
  features: Feature[];
}
const { features } = Astro.props;

const platforms = [
  { id: 'ios',      label: 'iOS',      color: '#007AFF' },
  { id: 'visionos', label: 'visionOS', color: '#AF52DE' },
  { id: 'macos',    label: 'macOS',    color: '#FF9F0A' },
];

// Category color map for left-border
const catColor: Record<string, string> = {
  rendering:   '#409CFF',
  lighting:    '#FFB340',
  audio:       '#30D158',
  physics:     '#FF453A',
  spatial:     '#BF5AF2',
  interaction: '#FF6B2B',
  camera:      '#5AC8FA',
  animation:   '#7D7AFF',
  media:       '#FF375F',
};

function withSoftBreaks(name: string): string {
  return name
    .replace(/([A-Z])([A-Z][a-z])/g, "$1\u200b$2")
    .replace(/([a-z0-9])([A-Z])/g, "$1\u200b$2");
}

function rowAriaLabel(f: typeof features[number]): string {
  const parts: string[] = [f.name, f.subcategory];
  const pMap: [string, string][] = [['ios','iOS'],['visionos','visionOS'],['macos','macOS']];
  for (const [id, label] of pMap) {
    const sup = f.support[id as keyof typeof f.support];
    parts.push(sup.status === 'y' ? `${label} ${sup.since ?? 'supported'}` : `${label} not supported`);
  }
  parts.push(f.rcp ? 'in Reality Composer Pro' : 'not in Reality Composer Pro');
  return parts.join(', ');
}
---

<div class="grid-scroll">
<div class="grid-shell" aria-label="RealityKit component compatibility">

  <!-- Column header row -->
  <div class="grid-header" aria-hidden="true">
    <div class="col-name">
      <span class="header-label">component</span>
    </div>
    {platforms.map(p => (
      <div class="col-platform" style={`--pcol: ${p.color};`}>
        <span class="platform-header-label">{p.label}</span>
      </div>
    ))}
    <div class="col-rcp">
      <span class="rcp-header-label">RCP</span>
    </div>
  </div>

  <!-- Feature rows -->
  <div class="grid-body">
    {features.map((f, i) => {
      const color = catColor[f.subcategory] ?? '#86868B';
      return (
        <a
          href={`/features/${f.id}`}
          class="grid-row"
          aria-label={rowAriaLabel(f)}
          data-subcategory={f.subcategory}
          data-name={f.name.toLowerCase()}
          style={`--cat-color: ${color}; --row-i: ${i};`}
        >
          <!-- Name + category -->
          <div class="col-name" aria-hidden="true">
            <div class="name-wrap">
              <span class="feature-name" title={f.name}>{withSoftBreaks(f.name)}</span>
              <span class="cat-label" style={`color: ${color}`}>{f.subcategory}</span>
            </div>
            {f.era === '26.0' && (
              <span class="new-badge">↑26</span>
            )}
          </div>

          <!-- Platform support cells (visual only — info in aria-label) -->
          {platforms.map(p => {
            const sup = f.support[p.id as keyof typeof f.support];
            const yes = sup.status === 'y';
            return (
              <div class="col-platform" aria-hidden="true">
                {yes ? (
                  <span class="support-yes">
                    <span class="dot" style={`color: ${p.color}`}>●</span>
                    <span class="ver" style={`color: ${p.color}`}>{sup.since ?? '✓'}</span>
                  </span>
                ) : (
                  <span class="support-no">—</span>
                )}
              </div>
            );
          })}

          <!-- RCP -->
          <div class="col-rcp" aria-hidden="true">
            {f.rcp ? (
              <span class="rcp-yes">✓</span>
            ) : (
              <span class="rcp-no">—</span>
            )}
          </div>
        </a>
      );
    })}
  </div>

</div>
</div>

<style>
  .grid-scroll {
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--surface);
    overflow-x: auto;
    overflow-y: visible;
    -webkit-overflow-scrolling: touch;
    position: relative;
    /* single-side gutter only — 'both-edges' steals ~30px from each side on Chrome/macOS */
    scrollbar-width: thin;
    scrollbar-color: var(--border-up) transparent;
  }

  /* ── Shell ───────────────────────────────────── */
  .grid-shell {
    /* Minimum width keeps columns legible when scrolling horizontally on mobile */
    min-width: 520px;
  }

  /* ── Column template ─────────────────────────── */
  .grid-header,
  .grid-row {
    display: grid;
    grid-template-columns: 1fr 112px 112px 112px 68px;
    gap: 0;
    align-items: stretch;
  }

  /* ── Header ──────────────────────────────────── */
  .grid-header {
    background: var(--surface-up);
    border-bottom: 1px solid var(--border);
    padding: 0;
    position: sticky;
    top: 0;
    z-index: 60;
    box-shadow: 0 1px 0 var(--border), 0 6px 14px rgba(0, 0, 0, 0.18);
  }

  .grid-header .col-name {
    padding: 0.625rem 1rem;
    border-right: 1px solid var(--border);
  }

  .grid-header .col-platform {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.625rem 0;
    border-right: 1px solid var(--border);
    border-top: 2px solid var(--pcol, var(--border));
    position: relative;
    overflow: hidden;
  }

  .grid-header .col-rcp {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.625rem 0;
    border-top: 2px solid var(--rcp);
    border-left: 1px solid var(--border);
  }

  .header-label {
    font-size: 0.6923rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--muted);
  }

  .platform-header-label {
    font-size: 0.6923rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--pcol);
  }

  @media (prefers-color-scheme: light) {
    .platform-header-label {
      color: color-mix(in srgb, var(--pcol), black 50%);
    }
  }

  .rcp-header-label {
    font-size: 0.6923rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--rcp);
  }

  /* ── Body ────────────────────────────────────── */
  .grid-body {
    display: flex;
    flex-direction: column;
  }

  /* ── Row ─────────────────────────────────────── */
  .grid-row {
    text-decoration: none;
    border-bottom: 1px solid var(--border);
    border-left: 2px solid transparent;
    background: transparent;
    transition: background 0.08s, border-left-color 0.08s;
    cursor: pointer;
    /* Staggered entrance */
    animation: rowIn 0.25s ease-out both;
    animation-delay: calc(var(--row-i, 0) * 12ms);
  }

  /* When motion is reduced (or disabled in DevTools), skip the animation entirely
     so rows don't stay frozen at opacity:0 from the animation fill-mode */
  @media (prefers-reduced-motion: reduce) {
    .grid-row {
      animation: none;
    }
  }

  .grid-row:last-child {
    border-bottom: none;
  }

  .grid-row:hover {
    background: var(--surface-up);
    border-left-color: var(--cat-color);
  }

  /* ── Name cell ───────────────────────────────── */
  .col-name {
    min-width: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    padding: 0.625rem 1rem;
    border-right: 1px solid var(--border);
  }

  .name-wrap {
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-width: 0;
  }

  .feature-name {
    font-size: 1rem;
    font-weight: 400;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
  }


  .cat-label {
    font-size: 0.6875rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    opacity: 0.85;
  }

  .new-badge {
    font-size: 0.6875rem;
    font-weight: 600;
    color: var(--macos);
    background: rgba(255, 159, 10, 0.1);
    border: 1px solid rgba(255, 159, 10, 0.2);
    padding: 1px 5px;
    border-radius: 3px;
    white-space: nowrap;
    flex-shrink: 0;
    letter-spacing: 0.04em;
  }

  /* ── Platform cell ───────────────────────────── */
  .col-platform {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 0;
    border-right: 1px solid var(--border);
  }

  .support-yes {
    display: flex;
    align-items: baseline;
    gap: 3px;
  }

  .dot {
    font-size: 0.5rem;
    line-height: 1;
    position: relative;
    top: -1px;
  }

  .ver {
    font-size: 0.9375rem;
    font-weight: 500;
    letter-spacing: -0.01em;
    font-variant-numeric: tabular-nums;
  }

  .support-no {
    font-size: 1rem;
    color: var(--subtle);
    font-weight: 300;
  }

  /* ── RCP cell ────────────────────────────────── */
  .col-rcp {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 0;
    border-left: 1px solid var(--border);
  }

  .rcp-yes {
    font-size: 0.7692rem;
    font-weight: 600;
    color: var(--rcp);
  }

  .rcp-no {
    font-size: 0.8462rem;
    color: var(--subtle);
    font-weight: 300;
  }

  @media (max-width: 1024px) {
    .grid-header,
    .grid-row {
      grid-template-columns: 1fr 98px 98px 98px 60px;
    }

    .feature-name {
      font-size: 0.9375rem;
    }
  }

  /* ── Mobile ──────────────────────────────────── */
  @media (max-width: 768px) {
    /*
     * 1fr approach: name column takes remaining space, platform columns fixed.
     * Table always fills its container width — no horizontal scroll, no dead gap.
     * Word-wrapping on feature-name handles long component names.
     *
     * 390px: 1fr = 390 - (68×3 + 52) = 390 - 256 = 134px for name ✓
     * 320px: 1fr = 320 - 256 = 64px for name (very compact, still readable with wrapping)
     */
    .grid-scroll {
      max-height: 68vh;
      overflow-y: auto;
      overflow-x: hidden; /* no horizontal scroll — table always fits */
    }

    .grid-shell {
      min-width: 0;
    }

    .grid-header,
    .grid-row {
      /*
       * 52px platform columns + 36px RCP → 1fr gets 166px on a 390px phone
       * (358px content − 32px padding − 192px fixed = 166px)
       * col-name text area = 166 − 16px inner padding = 150px ≈ 19 chars
       * "ManipulationCompon…" vs "ManipulationGesture…" — now distinguishable.
       */
      grid-template-columns: 1fr 52px 52px 52px 36px;
    }

    /* Remove sticky — not needed since table fits in viewport.
     * Grid layout: feature-name spans full width (top row),
     * cat-label + badge share the bottom row → badge no longer
     * competes with the name for horizontal space. */
    .col-name {
      position: static;
      box-shadow: none;
      background: transparent;
      padding: 0.5rem;
      display: grid;
      grid-template-areas:
        "name name"
        "cat  badge";
      grid-template-columns: 1fr auto;
      grid-template-rows: auto auto;
      gap: 0.1rem 0.375rem;
      align-items: center;
    }

    /* name-wrap dissolves so its children become direct grid items */
    .col-name .name-wrap {
      display: contents;
    }

    .col-name .feature-name {
      grid-area: name;
    }

    .col-name .cat-label {
      grid-area: cat;
    }

    .col-name .new-badge {
      grid-area: badge;
      font-size: 0.5625rem;
      padding: 0px 3px;
      align-self: center;
    }

    .grid-header .col-name {
      background: var(--surface-up);
    }

    .grid-row:hover .col-name,
    .grid-row:focus-within .col-name {
      background: var(--surface-up);
    }

    .feature-name {
      font-size: 0.8125rem;
      white-space: normal;
      overflow: hidden;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
      word-break: break-word;
    }

    .name-wrap {
      width: 100%;
      min-width: 0;
      gap: 0.25rem;
    }

    .new-badge {
      flex-shrink: 0;
    }

    .ver {
      font-size: 0.625rem; /* 10px — fits "26.0" in 52px column */
      letter-spacing: 0;
    }

    .col-platform {
      padding: 0.5rem 0.125rem;
    }

    .grid-header .col-rcp {
      padding: 0.625rem 0.25rem;
    }

    .platform-header-label {
      font-size: 0.55rem;
      letter-spacing: 0.04em;
    }

    .rcp-header-label {
      font-size: 0.6rem;
      letter-spacing: 0.04em;
    }
  }
</style>
