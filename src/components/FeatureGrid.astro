---
import type { Feature } from "../types";

export interface Props {
  features: Feature[];
}
const { features } = Astro.props;

const platforms = [
  { id: 'ios',      label: 'iOS',      color: '#007AFF' },
  { id: 'visionos', label: 'visionOS', color: '#AF52DE' },
  { id: 'macos',    label: 'macOS',    color: '#FF9F0A' },
];

// Category color map for left-border
const catColor: Record<string, string> = {
  rendering:   '#409CFF',
  lighting:    '#FFB340',
  audio:       '#30D158',
  physics:     '#FF453A',
  spatial:     '#BF5AF2',
  interaction: '#FF6B2B',
  camera:      '#5AC8FA',
  animation:   '#7D7AFF',
  media:       '#FF375F',
};

function withSoftBreaks(name: string): string {
  return name
    .replace(/([A-Z])([A-Z][a-z])/g, "$1\u200b$2")
    .replace(/([a-z0-9])([A-Z])/g, "$1\u200b$2");
}
---

<div class="grid-scroll">
<div class="grid-shell" role="table" aria-label="RealityKit component compatibility">

  <!-- Column header row -->
  <div class="grid-header" role="row">
    <div class="col-name" role="columnheader">
      <span class="header-label">component</span>
    </div>
    {platforms.map(p => (
      <div class="col-platform" role="columnheader" style={`--pcol: ${p.color};`}>
        <span class="platform-header-label" style={`color: ${p.color}`}>{p.label}</span>
      </div>
    ))}
    <div class="col-rcp" role="columnheader">
      <span class="rcp-header-label">RCP</span>
    </div>
  </div>

  <!-- Feature rows -->
  <div class="grid-body" role="rowgroup">
    {features.map((f, i) => {
      const color = catColor[f.subcategory] ?? '#86868B';
      return (
        <a
          href={`/features/${f.id}`}
          class="grid-row"
          role="row"
          data-subcategory={f.subcategory}
          data-name={f.name.toLowerCase()}
          style={`--cat-color: ${color}; --row-i: ${i};`}
        >
          <!-- Name + category -->
          <div class="col-name" role="cell">
            <div class="name-wrap">
              <span class="feature-name">{withSoftBreaks(f.name)}</span>
              <span class="cat-label" style={`color: ${color}`}>{f.subcategory}</span>
            </div>
            {f.era === '26.0' && (
              <span class="new-badge" aria-label="New in 26.0">↑26</span>
            )}
          </div>

          <!-- Platform support cells -->
          {platforms.map(p => {
            const sup = f.support[p.id as keyof typeof f.support];
            const yes = sup.status === 'y';
            return (
              <div class="col-platform" role="cell">
                {yes ? (
                  <span class="support-yes">
                    <span class="dot" style={`color: ${p.color}`}>●</span>
                    <span class="ver" style={`color: ${p.color}`}>{sup.since ?? '✓'}</span>
                  </span>
                ) : (
                  <span class="support-no" aria-label="not supported">—</span>
                )}
              </div>
            );
          })}

          <!-- RCP -->
          <div class="col-rcp" role="cell">
            {f.rcp ? (
              <span class="rcp-yes" aria-label="available in Reality Composer Pro">✓</span>
            ) : (
              <span class="rcp-no" aria-hidden="true">—</span>
            )}
          </div>
        </a>
      );
    })}
  </div>

</div>
</div>

<style>
  .grid-scroll {
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--surface);
    overflow-x: auto;
    overflow-y: visible;
    -webkit-overflow-scrolling: touch;
    position: relative;
  }

  /* ── Shell ───────────────────────────────────── */
  .grid-shell {
    /* Minimum width keeps columns legible when scrolling horizontally on mobile */
    min-width: 520px;
  }

  /* ── Column template ─────────────────────────── */
  .grid-header,
  .grid-row {
    display: grid;
    grid-template-columns: 1fr 112px 112px 112px 68px;
    gap: 0;
  }

  /* ── Header ──────────────────────────────────── */
  .grid-header {
    background: var(--surface-up);
    border-bottom: 1px solid var(--border);
    padding: 0;
    position: sticky;
    top: 0;
    z-index: 60;
    box-shadow: 0 1px 0 var(--border), 0 6px 14px rgba(0, 0, 0, 0.18);
  }

  .grid-header .col-name {
    padding: 0.625rem 1rem;
    border-right: 1px solid var(--border);
  }

  .grid-header .col-platform {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.625rem 0;
    border-right: 1px solid var(--border);
    border-top: 2px solid var(--pcol, var(--border));
    position: relative;
  }

  .grid-header .col-rcp {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.625rem 0;
    border-top: 2px solid var(--rcp);
  }

  .header-label {
    font-size: 0.6923rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--muted);
  }

  .platform-header-label {
    font-size: 0.6923rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .rcp-header-label {
    font-size: 0.6923rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--rcp);
  }

  /* ── Body ────────────────────────────────────── */
  .grid-body {
    display: flex;
    flex-direction: column;
  }

  /* ── Row ─────────────────────────────────────── */
  .grid-row {
    text-decoration: none;
    border-bottom: 1px solid var(--border);
    border-left: 2px solid transparent;
    background: transparent;
    transition: background 0.08s, border-left-color 0.08s;
    cursor: pointer;
    /* Staggered entrance */
    animation: rowIn 0.25s ease-out both;
    animation-delay: calc(var(--row-i, 0) * 12ms);
  }

  /* When motion is reduced (or disabled in DevTools), skip the animation entirely
     so rows don't stay frozen at opacity:0 from the animation fill-mode */
  @media (prefers-reduced-motion: reduce) {
    .grid-row {
      animation: none;
    }
  }

  .grid-row:last-child {
    border-bottom: none;
  }

  .grid-row:hover {
    background: var(--surface-up);
    border-left-color: var(--cat-color);
  }

  /* ── Name cell ───────────────────────────────── */
  .col-name {
    min-width: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    padding: 0.625rem 1rem;
    border-right: 1px solid var(--border);
  }

  .name-wrap {
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-width: 0;
  }

  .feature-name {
    font-size: 1rem;
    font-weight: 400;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .cat-label {
    font-size: 0.6875rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    opacity: 0.85;
  }

  .new-badge {
    font-size: 0.6875rem;
    font-weight: 600;
    color: var(--macos);
    background: rgba(255, 159, 10, 0.1);
    border: 1px solid rgba(255, 159, 10, 0.2);
    padding: 1px 5px;
    border-radius: 3px;
    white-space: nowrap;
    flex-shrink: 0;
    letter-spacing: 0.04em;
  }

  /* ── Platform cell ───────────────────────────── */
  .col-platform {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 0;
    border-right: 1px solid var(--border);
  }

  .support-yes {
    display: flex;
    align-items: baseline;
    gap: 3px;
  }

  .dot {
    font-size: 0.5rem;
    line-height: 1;
    position: relative;
    top: -1px;
  }

  .ver {
    font-size: 0.9375rem;
    font-weight: 500;
    letter-spacing: -0.01em;
    font-variant-numeric: tabular-nums;
  }

  .support-no {
    font-size: 1rem;
    color: var(--subtle);
    font-weight: 300;
  }

  /* ── RCP cell ────────────────────────────────── */
  .col-rcp {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 0;
  }

  .rcp-yes {
    font-size: 0.7692rem;
    font-weight: 600;
    color: var(--rcp);
  }

  .rcp-no {
    font-size: 0.8462rem;
    color: var(--subtle);
    font-weight: 300;
  }

  @media (max-width: 1024px) {
    .grid-header,
    .grid-row {
      grid-template-columns: 1fr 98px 98px 98px 60px;
    }

    .feature-name {
      font-size: 0.9375rem;
    }
  }

  /* ── Mobile ──────────────────────────────────── */
  @media (max-width: 768px) {
    /*
     * Sticky-first-column pattern:
     * - Grid shell becomes the horizontal scroll container
     * - Name column sticks to left:0 so it never scrolls away
     * - Fixed column widths → predictable total (~414px, ~56px overflow on 390px)
     */
    .grid-scroll {
      max-height: 68vh;
      overflow-y: auto;
    }

    .grid-shell {
      min-width: 0;
      /* Total column widths 360px — fits in 358px content area, no initial scroll */
    }

    .grid-header,
    .grid-row {
      grid-template-columns: 186px 68px 68px 68px 40px;
    }

    /* Name column sticks so component labels are always visible */
    .col-name {
      position: sticky;
      left: 0;
      z-index: 2;
      background: var(--surface);
      /* Soft shadow separates sticky from scrolling data columns */
      box-shadow: 2px 0 6px -1px rgba(0, 0, 0, 0.35);
      display: grid;
      grid-template-columns: 1fr;
      align-items: start;
      gap: 0.35rem;
    }

    .grid-header .col-name {
      background: var(--surface-up);
    }

    .grid-row:hover .col-name,
    .grid-row:focus-within .col-name {
      background: var(--surface-up);
    }

    /* Tighter text for compact cells */
    .feature-name {
      font-size: 0.8125rem;
      white-space: normal;
      overflow: hidden;
      text-overflow: unset;
      line-height: 1.2;
      max-width: 100%;
      overflow-wrap: anywhere;
      word-break: break-word;
      display: block;
    }

    .name-wrap {
      width: 100%;
      gap: 0.3rem;
    }

    .new-badge {
      justify-self: start;
      margin-top: 0;
    }

    .ver {
      font-size: 0.75rem;
    }

    .col-platform {
      padding: 0.5rem 0.25rem;
    }
  }

  @media (max-width: 420px) {
    .grid-header,
    .grid-row {
      grid-template-columns: 170px 64px 64px 64px 36px;
    }
  }
</style>
